<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°æ•°æ®ç®¡ç†è°ƒè¯•æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-button { background: #007acc; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; }
        .test-button:hover { background: #005a9e; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .result-area { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸ› ï¸ åå°æ•°æ®ç®¡ç†è°ƒè¯•æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ğŸ“Š æ•°æ®å­˜å‚¨æµ‹è¯•</h2>
        <button class="test-button" onclick="testDataStorage()">æµ‹è¯•æ•°æ®å­˜å‚¨</button>
        <button class="test-button" onclick="addTestArtwork()">æ·»åŠ æµ‹è¯•ä½œå“</button>
        <button class="test-button" onclick="listAllArtworks()">åˆ—å‡ºæ‰€æœ‰ä½œå“</button>
        <button class="test-button" onclick="clearTestData()">æ¸…ç©ºæµ‹è¯•æ•°æ®</button>
        <div id="storage-result" class="result-area"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ”„ æ•°æ®åŒæ­¥æµ‹è¯•</h2>
        <button class="test-button" onclick="testDataSync()">æµ‹è¯•æ•°æ®åŒæ­¥</button>
        <button class="test-button" onclick="triggerFrontendUpdate()">è§¦å‘å‰å°æ›´æ–°</button>
        <button class="test-button" onclick="monitorSyncStatus()">ç›‘æ§åŒæ­¥çŠ¶æ€</button>
        <div id="sync-result" class="result-area"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸŒ BroadcastChannel æµ‹è¯•</h2>
        <button class="test-button" onclick="testBroadcastChannel()">æµ‹è¯•å¹¿æ’­é€šé“</button>
        <button class="test-button" onclick="listenBroadcast()">å¼€å§‹ç›‘å¬å¹¿æ’­</button>
        <div id="broadcast-result" class="result-area"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ’¾ LocalStorage çŠ¶æ€</h2>
        <button class="test-button" onclick="showStorageStatus()">æ˜¾ç¤ºå­˜å‚¨çŠ¶æ€</button>
        <div id="storage-status" class="result-area"></div>
    </div>

    <script src="./js/data-manager.js"></script>
    <script>
        const dataManager = new DataManager();
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            const line = `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            element.innerHTML += line;
            element.scrollTop = element.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function testDataStorage() {
            log('storage-result', 'å¼€å§‹æµ‹è¯•æ•°æ®å­˜å‚¨åŠŸèƒ½...', 'info');
            
            try {
                // æµ‹è¯•ä½œå“æ•°æ®
                const artworks = dataManager.getArtworks();
                log('storage-result', `å½“å‰ä½œå“æ•°é‡: ${artworks.length}`, 'info');
                
                // æµ‹è¯•ä¸ªäººä¿¡æ¯
                const profile = dataManager.getProfile();
                log('storage-result', `ä¸ªäººä¿¡æ¯å­˜åœ¨: ${profile ? 'æ˜¯' : 'å¦'}`, 'info');
                if (profile) {
                    log('storage-result', `è‰ºæœ¯å®¶å§“å: ${profile.name}`, 'info');
                }
                
                // æµ‹è¯•å¤šè¯­è¨€æ•°æ®
                const i18n = dataManager.getI18nData();
                log('storage-result', `å¤šè¯­è¨€æ•°æ®æ”¯æŒè¯­è¨€: ${Object.keys(i18n).join(', ')}`, 'info');
                
                log('storage-result', 'âœ… æ•°æ®å­˜å‚¨æµ‹è¯•å®Œæˆ', 'success');
                
            } catch (error) {
                log('storage-result', `âŒ æ•°æ®å­˜å‚¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function addTestArtwork() {
            log('storage-result', 'æ·»åŠ æµ‹è¯•ä½œå“...', 'info');
            
            try {
                const timestamp = Date.now();
                const artwork = {
                    titleKey: `test-artwork-${timestamp}-title`,
                    descriptionKey: `test-artwork-${timestamp}-desc`, 
                    category: 'digital',
                    image: `https://via.placeholder.com/400x300/007acc/white?text=Test+${timestamp}`,
                    details: {
                        medium: 'æ•°å­—è‰ºæœ¯',
                        size: '1920x1080',
                        year: '2025'
                    }
                };
                
                // æ·»åŠ å¤šè¯­è¨€æ•°æ®
                const i18nData = dataManager.getI18nData();
                i18nData.zh[artwork.titleKey] = `æµ‹è¯•ä½œå“ ${timestamp}`;
                i18nData.en[artwork.titleKey] = `Test Artwork ${timestamp}`;
                i18nData.ja[artwork.titleKey] = `ãƒ†ã‚¹ãƒˆä½œå“ ${timestamp}`;
                
                i18nData.zh[artwork.descriptionKey] = `è¿™æ˜¯æµ‹è¯•ä½œå“çš„æè¿° ${timestamp}`;
                i18nData.en[artwork.descriptionKey] = `This is test artwork description ${timestamp}`;
                i18nData.ja[artwork.descriptionKey] = `ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆä½œå“ã®èª¬æ˜ã§ã™ ${timestamp}`;
                
                dataManager.setI18nData(i18nData);
                
                const newArtwork = dataManager.addArtwork(artwork);
                log('storage-result', `âœ… æˆåŠŸæ·»åŠ æµ‹è¯•ä½œå“ï¼ŒID: ${newArtwork.id}`, 'success');
                
                // è§¦å‘åŒæ­¥
                setTimeout(() => {
                    triggerFrontendUpdate();
                }, 100);
                
            } catch (error) {
                log('storage-result', `âŒ æ·»åŠ æµ‹è¯•ä½œå“å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function listAllArtworks() {
            log('storage-result', 'åˆ—å‡ºæ‰€æœ‰ä½œå“...', 'info');
            
            try {
                const artworks = dataManager.getArtworks();
                const i18nData = dataManager.getI18nData();
                
                log('storage-result', `=== ä½œå“åˆ—è¡¨ (${artworks.length} ä»¶) ===`, 'info');
                
                artworks.forEach(artwork => {
                    const title = i18nData.zh[artwork.titleKey] || artwork.titleKey;
                    log('storage-result', `ID: ${artwork.id} | ${title} | ${artwork.category}`, 'info');
                });
                
                if (artworks.length === 0) {
                    log('storage-result', 'æ²¡æœ‰æ‰¾åˆ°ä½œå“', 'info');
                }
                
            } catch (error) {
                log('storage-result', `âŒ åˆ—å‡ºä½œå“å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function clearTestData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æµ‹è¯•æ•°æ®å—ï¼Ÿ')) {
                log('storage-result', 'æ¸…ç©ºæµ‹è¯•æ•°æ®...', 'info');
                try {
                    // åªä¿ç•™éæµ‹è¯•æ•°æ®
                    const artworks = dataManager.getArtworks();
                    const filteredArtworks = artworks.filter(artwork => 
                        !artwork.titleKey.includes('test-artwork-')
                    );
                    
                    dataManager.setArtworks(filteredArtworks);
                    
                    log('storage-result', `âœ… æ¸…ç©ºå®Œæˆï¼Œä¿ç•™ ${filteredArtworks.length} ä»¶éæµ‹è¯•ä½œå“`, 'success');
                    
                } catch (error) {
                    log('storage-result', `âŒ æ¸…ç©ºæ•°æ®å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }
        
        function testDataSync() {
            log('sync-result', 'æµ‹è¯•æ•°æ®åŒæ­¥åŠŸèƒ½...', 'info');
            
            try {
                const timestamp = Date.now();
                
                // æ¨¡æ‹Ÿåå°æ•°æ®æ›´æ–°
                localStorage.setItem('sync_timestamp', timestamp.toString());
                log('sync-result', `è®¾ç½®åŒæ­¥æ—¶é—´æˆ³: ${timestamp}`, 'info');
                
                // è®¾ç½®æ›´æ–°æ ‡è®°
                localStorage.setItem('last_admin_update', JSON.stringify({
                    timestamp: timestamp,
                    type: 'test_sync',
                    action: 'debug_test'
                }));
                log('sync-result', 'è®¾ç½®ç®¡ç†å‘˜æ›´æ–°æ ‡è®°', 'info');
                
                log('sync-result', 'âœ… æ•°æ®åŒæ­¥æ ‡è®°å·²è®¾ç½®', 'success');
                
            } catch (error) {
                log('sync-result', `âŒ æ•°æ®åŒæ­¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function triggerFrontendUpdate() {
            log('sync-result', 'è§¦å‘å‰å°æ•°æ®æ›´æ–°...', 'info');
            
            try {
                const timestamp = Date.now();
                
                // æ–¹æ³•1: BroadcastChannel
                if ('BroadcastChannel' in window) {
                    const channel = new BroadcastChannel('artwork_updates');
                    channel.postMessage({
                        type: 'DATA_UPDATED',
                        timestamp: timestamp,
                        keys: ['artworks_data', 'i18n_data', 'profile_data']
                    });
                    log('sync-result', 'ğŸ“¡ é€šè¿‡BroadcastChannelå‘é€æ›´æ–°é€šçŸ¥', 'success');
                }
                
                // æ–¹æ³•2: å¼ºåˆ¶è§¦å‘storageäº‹ä»¶
                const storageEvent = new StorageEvent('storage', {
                    key: 'artworks_data',
                    newValue: localStorage.getItem('artworks_data'),
                    oldValue: null,
                    storageArea: localStorage,
                    url: window.location.href
                });
                window.dispatchEvent(storageEvent);
                log('sync-result', 'ğŸš€ æ‰‹åŠ¨è§¦å‘storageäº‹ä»¶', 'success');
                
                // æ–¹æ³•3: æ›´æ–°æ ‡è®°
                localStorage.setItem('last_admin_update', JSON.stringify({
                    timestamp: timestamp,
                    type: 'manual_trigger',
                    action: 'frontend_update'
                }));
                log('sync-result', 'â° æ›´æ–°åŒæ­¥æ ‡è®°', 'success');
                
                log('sync-result', 'âœ… å‰å°æ›´æ–°è§¦å‘å®Œæˆ', 'success');
                
            } catch (error) {
                log('sync-result', `âŒ è§¦å‘å‰å°æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function monitorSyncStatus() {
            log('sync-result', 'å¼€å§‹ç›‘æ§åŒæ­¥çŠ¶æ€...', 'info');
            
            let lastCheck = localStorage.getItem('last_admin_update');
            const monitor = setInterval(() => {
                const currentCheck = localStorage.getItem('last_admin_update');
                if (currentCheck !== lastCheck) {
                    lastCheck = currentCheck;
                    const data = JSON.parse(currentCheck || '{}');
                    log('sync-result', `ğŸ”„ æ£€æµ‹åˆ°åŒæ­¥æ›´æ–°: ${data.type} at ${new Date(data.timestamp).toLocaleTimeString()}`, 'info');
                }
            }, 1000);
            
            // 10ç§’ååœæ­¢ç›‘æ§
            setTimeout(() => {
                clearInterval(monitor);
                log('sync-result', 'â¹ï¸ åŒæ­¥ç›‘æ§å·²åœæ­¢', 'info');
            }, 10000);
        }
        
        function testBroadcastChannel() {
            if (!('BroadcastChannel' in window)) {
                log('broadcast-result', 'âŒ æµè§ˆå™¨ä¸æ”¯æŒBroadcastChannel', 'error');
                return;
            }
            
            log('broadcast-result', 'æµ‹è¯•BroadcastChannel...', 'info');
            
            const channel = new BroadcastChannel('artwork_updates');
            channel.postMessage({
                type: 'TEST_MESSAGE',
                message: 'Hello from debug test!',
                timestamp: Date.now()
            });
            
            log('broadcast-result', 'ğŸ“¡ æµ‹è¯•æ¶ˆæ¯å·²å‘é€', 'success');
        }
        
        function listenBroadcast() {
            if (!('BroadcastChannel' in window)) {
                log('broadcast-result', 'âŒ æµè§ˆå™¨ä¸æ”¯æŒBroadcastChannel', 'error');
                return;
            }
            
            log('broadcast-result', 'å¼€å§‹ç›‘å¬BroadcastChannel...', 'info');
            
            const channel = new BroadcastChannel('artwork_updates');
            channel.addEventListener('message', function(e) {
                log('broadcast-result', `ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(e.data)}`, 'success');
            });
            
            log('broadcast-result', 'âœ… BroadcastChannelç›‘å¬å™¨å·²å¯åŠ¨', 'success');
        }
        
        function showStorageStatus() {
            log('storage-status', 'æ˜¾ç¤ºlocalStorageçŠ¶æ€...', 'info');
            
            const keys = [
                'artworks_data', 
                'profile_data', 
                'i18n_data', 
                'site_config',
                'sync_timestamp',
                'last_admin_update'
            ];
            
            keys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        let size = JSON.stringify(parsed).length;
                        let summary = '';
                        
                        if (key === 'artworks_data' && Array.isArray(parsed)) {
                            summary = `${parsed.length} ä»¶ä½œå“`;
                        } else if (key === 'i18n_data') {
                            summary = `${Object.keys(parsed).length} ç§è¯­è¨€`;
                        } else if (key === 'profile_data') {
                            summary = `è‰ºæœ¯å®¶: ${parsed.name || 'æœªçŸ¥'}`;
                        }
                        
                        log('storage-status', `âœ… ${key}: ${size} å­—èŠ‚ ${summary}`, 'success');
                    } catch (e) {
                        log('storage-status', `âš ï¸ ${key}: æ•°æ®æ ¼å¼é”™è¯¯`, 'error');
                    }
                } else {
                    log('storage-status', `âŒ ${key}: ä¸å­˜åœ¨`, 'error');
                }
            });
            
            log('storage-status', `æ€»è®¡localStorageä½¿ç”¨: ${JSON.stringify(localStorage).length} å­—èŠ‚`, 'info');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ˜¾ç¤ºçŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            showStorageStatus();
        });
    </script>
</body>
</html>